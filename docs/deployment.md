# Deployment

This page is about the deployment procedure, which we can test by deploying on testnet (and mainnet). This will eventually be used for final deployment on mainnet.

## Targets of deployment procedure

There are 3 targets of deployment procedure:

Target | Description
--- | ---
Deployment on **testnet** | Used to preliminary test the deployment script.
**Trial** deployment on **mainnet** | Used to make sure that the differences between testnet and mainnet do not result in any failures. Assert that the deployment script works properly, there are no timeouts or out-of-gas exceptions. Just to be extra sure that everything works correctly.
**Final** deployment on **mainnet** | Final deployment resulting in started migration.

## Deployment procedure - Ownership perspective

The steps of deployment procedure can be divided by a person responsible of executing it. It is important to specify who deploys and using which private key. One of the steps is critical and should be performed by a Golem representative. Other steps are not critical and could be performed by 3rd party with any funded private keys.

private keys holder | Hereafter referred to as | Description
--- | --- | ---
a Golem representative | `golemMigrationMaster` | This must be the migration master of current `GNT`. The private key must not be available in other steps of deployment procedure
designed person for executing the deployment | `3rdPartyDeployer` | Anyone can be designed to perform non-critial parts of the procedure, because nothing is really effective unless the final step is executed by `golemMigrationMaster`. It might as well be performed by a 3rd party, hence name `3rdPartyDeployer` to emphasize that it is not critical.

## Deployment procedure in exact steps

No. |  Step | When applicable | Who performs | Details
--- | --- | --- | --- | ---
1 | Deploy and configure `GNT` | In testnet deployment only | anyone | Mint tokens for some test users
2 | Deploy and configure `GNTB` | In testnet deployment only | anyone | -
3 | Deploy `GNTMigrationAgent` | Always | `3rdPartyDeployer` | The `3rdPartyDeployer` owns the `GNTMigrationAgent` thereafter
4 | Deploy `NGNT` | Always | `3rdPartyDeployer` | By design the `NGNT` is not owned by the deployer
5 | Configure `GNTMigrationAgent` | Always | `3rdPartyDeployer` | `setTarget()` targetting `NGNT`
6 | Change ownership of `GNTMigrationAgent` | Always | `3rdPartyDeployer` | Transfer ownership to `golemMigrationMaster`.
7 | Configure `GNT` | After announced migration launch date | `golemMigrationMaster` | `setMigrationAgent()` targetting `GNTMigrationAgent`. This is a **critical** step and should be separated from the rest of the procedure. `setMigrationAgent()` can only be executed **once**.

Note that shutting down the migration by `setMigrationAgent()` in `GNT` is not possible (can only be set once).

- **Important implication** - The only way to shut down the migration (or execute the emergency recovery) seems to be the `setTarget()` executed by owner of the `GNTMigrationAgent`. That's why transferring ownership of `GNTMigrationAgent` to Golem's side is important.

## Assertions after 3rd party deployment

The following assertions must be taken place after steps performed by `3rdPartyDeployer` are complete, and before attempting final step by `golemMigrationMaster`:

- `GNTMigrationAgent` and `NGNT` source code is verified on Etherscan
- `GNTMigrationAgent` and `NGNT` bytecode on Etherscan is an exact match compared to bytecode generated by compiling the contracts using latest `master`
- The **only** minter of `NGNT` is `GNTMigrationAgent`
- The are no events or transactions executed on `NGNT` besides constructing transaction
- The owner of `GNTMigrationAgent` is `golemMigrationMaster`
- The target of `GNTMigrationAgent` is `NGNT`
- The only transactions executed on `GNTMigrationAgent` are:
    - Constructing transaction
    - `setTarget()` transaction

## Renouncing ownership in exact steps

This happens after the migration has been running for a while with no issues.

No. |  Step | Who performs | Details
--- | --- | --- | ---
1 | Give up ownership of `NGNT` | `golemMigrationMaster` | `renounceOwnership()` on `NGNT`

---

# Proactive preparation of Recovery

The common first steps of Emergency Recovery procedures is shutting down the migration using `setTarget()`.
The step can be proactively prepared ahead of time by gathering `K-1` signatures for the transaction, leaving only one signature required to kick off the transaction.

Current multisig of `golemMigrationMaster` is [here](https://etherscan.io/address/0x7da82c7ab4771ff031b66538d2fb9b0b047f6cf9#code).

---

# Recovery

There are 2 flavors of recovery procedure:

- Restore to migration point
- Community freeze

## Restore to migration point in exact steps

No. |  Step | Who performs | Details
--- | --- | --- | ---
1 | Dis-configure `GNTMigrationAgent` | `golemMigrationMaster` | `setTarget()` targetting a `0x0` address
2 | Deploy modified `NGNT` | `3rdPartyDeployer`| Modified in a way to NOT renounce minter rights upon construction
3 | Mint balances | `3rdPartyDeployer`| Mint balances according to `GNTMigrationAgent` records
3 | Renounce minter rights | `3rdPartyDeployer`| -
4 | Configure `GNTMigrationAgent` | `golemMigrationMaster` | `setTarget()` targetting the modified `NGNT`

## Community freeze in exact steps

No. |  Step | Who performs | Details
--- | --- | --- | ---
1 | Dis-configure `GNTMigrationAgent` | `golemMigrationMaster` | `setTarget()` targetting a `0x0` address
2 | Announce `updateBlock` | Golem PR representative | An arbitrary block in the future
3 | Deploy modified `NGNT` | `3rdPartyDeployer`| Modified in a way to NOT renounce minter rights upon construction
4 | Mint balances | `3rdPartyDeployer`| Mint balances according to previous `NGNT` balances in `updateBlock` block.
5 | Renounce minter rights | `3rdPartyDeployer`| -
6 | Configure `GNTMigrationAgent` | `golemMigrationMaster` | `setTarget()` targetting the modified `NGNT`
